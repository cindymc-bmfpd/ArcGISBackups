<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArcGIS Online Backup</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 640px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.25rem; margin-bottom: 1rem; }
    section { margin-bottom: 1.5rem; }
    label { display: block; margin-top: 0.5rem; font-weight: 500; }
    input[type="text"], input[type="password"], textarea, select { width: 100%; padding: 0.4rem; margin-top: 0.2rem; box-sizing: border-box; }
    textarea { min-height: 80px; resize: vertical; }
    button, .btn { padding: 0.5rem 1rem; margin-top: 0.5rem; cursor: pointer; }
    .status { margin-top: 1rem; padding: 0.75rem; border-radius: 4px; white-space: pre-wrap; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    .backup-section { border: 1px solid #ccc; padding: 1rem; border-radius: 4px; }
    .search-results { margin-top: 0.5rem; max-height: 200px; overflow-y: auto; }
    .search-results label { display: flex; align-items: center; gap: 0.5rem; font-weight: normal; }
    .search-results input[type="checkbox"] { width: auto; }
    .hint { font-size: 0.875rem; color: #666; margin-top: 0.25rem; }
  </style>
</head>
<body>
  <h1>ArcGIS Online Backup</h1>

  {% if session_message[0] %}
  <div class="status {{ session_message[1] }}" role="alert">{{ session_message[0] }}</div>
  {% endif %}

  <section>
    <h2>Log in</h2>
    <form method="post" action="{{ url_for('login') }}">
      <label for="gis_url">ArcGIS URL</label>
      <input type="text" id="gis_url" name="gis_url" value="{{ gis_url }}" placeholder="{{ default_ago_url }}">
      <label for="username">Username</label>
      <input type="text" id="username" name="username" value="{{ username }}" autocomplete="username">
      <label for="password">Password</label>
      <input type="password" id="password" name="password" autocomplete="current-password">
      <button type="submit">Login</button>
    </form>
    {% if logged_in %}
    <form method="post" action="{{ url_for('logout') }}" style="display:inline; margin-left: 0.5rem;">
      <button type="submit">Logout</button>
    </form>
    {% endif %}
  </section>

  {% if logged_in %}
  <section class="backup-section">
    <h2>Backup layers and maps</h2>
    <p class="hint">Backups are saved under: <code>{{ backup_base_path }}</code>. You can enter a subfolder name or leave empty.</p>

    <h3>Search my content</h3>
    <form method="post" action="{{ url_for('search') }}">
      <label for="content_folder">Content folder (optional)</label>
      <select id="content_folder" name="content_folder">
        <option value="" {% if not last_content_folder %}selected{% endif %}>All folders</option>
        {% for folder in user_folders %}
        <option value="{{ folder.id }}" {% if last_content_folder == folder.id %}selected{% endif %}>{{ folder.title }}</option>
        {% endfor %}
      </select>
      <label for="item_type">Item type</label>
      <select id="item_type" name="item_type">
        {% for value, label in search_item_types %}
        <option value="{{ value }}" {% if last_item_type == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <button type="submit">Search</button>
    </form>

    {% if search_results %}
    <div class="search-results">
      <p class="hint">Select items to add to the backup list, then click "Add selected".</p>
      {% for item in search_results %}
      <label>
        <input type="checkbox" class="search-item-cb" data-id="{{ item.id | e }}" data-title="{{ item.title | e }}">
        <span>{{ item.title }} ({{ item.type }}) â€” {{ item.id }}</span>
      </label>
      {% endfor %}
      <button type="button" class="btn" id="add-selected">Add selected to backup list</button>
    </div>
    {% endif %}

    <form method="post" action="{{ url_for('backup') }}" id="backup-form">
      <label for="backup_path">Backup folder (optional subpath)</label>
      <input type="text" id="backup_path" name="backup_path" placeholder="e.g. 2025-02 or leave empty">
      <label for="item_ids">Item IDs (comma- or newline-separated)</label>
      <textarea id="item_ids" name="item_ids" placeholder="Paste item IDs here, or use Search above to add them"></textarea>
      <p class="hint">Backup may take a few minutes. The package will be saved in the folder you chose.</p>
      <button type="submit" id="run-backup">Run backup</button>
    </form>
  </section>
  {% endif %}

  <script>
    (function() {
      document.addEventListener('click', function(e) {
        if (!e.target || e.target.id !== 'add-selected') return;
        var checkboxes = document.querySelectorAll('.search-item-cb:checked');
        var ids = Array.from(checkboxes)
          .map(function(cb) { return cb.getAttribute('data-id'); })
          .filter(Boolean);
        var textarea = document.getElementById('item_ids');
        if (!textarea) return;
        var existing = (textarea.value || '').trim();
        var existingIds = existing ? existing.split(/[\s,\n]+/).filter(Boolean) : [];
        var combined = existingIds.concat(ids);
        var unique = combined.filter(function(id, i) { return combined.indexOf(id) === i; });
        textarea.value = unique.join('\n');
      });
    })();
  </script>
</body>
</html>
